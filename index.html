<!DOCTYPE html>
<html lang="zh-TW">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>夙夙專用門診排班轉換工具</title>
 <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

 <style>
  body{font-family:'微軟正黑體', sans-serif; background:#f4f7f6; padding:20px;}
  .container{max-width:850px; margin:auto; background:white; padding:30px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1);}
  h1,h2{text-align:center; color:#003366;}
  label{font-weight:bold; margin-top:20px; display:block;}
  input[type=file]{width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; background:#eef0f3;}
  button{margin-top:25px; width:100%; padding:12px; background:#0066cc; color:white; font-size:16px; border:none; border-radius:6px; cursor: pointer;}
  button:hover{background:#004c99;}
  .error{margin-top:15px; padding:10px; background:#ffe5e5; border-left:4px solid #cc0000; color:#990000;}
  .note{font-size:12px; color:#666;}
  .success{padding:10px; background:#e6ffe6; border-left:4px solid #2d862d; color:#1b5e20;}
  #progressContainer{ display:none; margin-top:25px;}
  .progress-bar { width: 100%; background-color: #ddd; border-radius: 6px; overflow: hidden;}
  .progress-bar-fill { height: 18px; width: 0%; background-color: #4CAF50; transition: width 0.25s ease-out;}
  #doneMessage { display:none; margin-top:20px; padding:10px; background:#e6ffe6; border-left:4px solid #2d862d; text-align:center; font-size:15px; color:#1b5e20;}
  .mode-selection { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 6px;}
  .mode-selection label { font-weight: normal; margin-top: 0; cursor: pointer; padding: 10px; border: 1px solid transparent; border-radius: 4px;}
  .mode-selection input[type="radio"]:checked + label { border: 1px solid #0066cc; background-color: #e6f7ff;}
 </style>
</head>
<body>

<div class="container">
 <h1>三軍總醫院北投分院</h1>
 <h2>護理科門診排班轉換工具</h2>
 <div id="messageArea"></div>

 <form id="uploadForm">
  <label>步驟 1：診次設定（請上傳僅A欄位有診次別的.xlsx檔）</label>
  <div id="clinicStatus"></div>
  <input type="file" id="clinicFile" accept=".xlsx">
  <div class="note">第一次使用必須上傳，之後會自動記憶；若未變更診別，不用重新上傳。</div>

  <label>步驟 2：上傳預轉換的區間班表 (排班設定檔.xlsx)</label>
  <input type="file" id="scheduleFile" accept=".xlsx" required>
 
  <label style="margin-top: 30px;">步驟 3：選擇分配表提取模式（擇一執行）</label>
  <div class="mode-selection">
   <label for="mode_auto">
    <input type="radio" name="extractionMode" value="auto" id="mode_auto" checked>
    <span style="font-weight: bold;">月班表模式</span>
    <div class="note">依日期區間，以週間日期分頁。</div>
   </label>
   <label for="mode_fixed">
    <input type="radio" name="extractionMode" value="fixed" id="mode_fixed">
    <span style="font-weight: bold;">週班表模式</span>
    <div class="note">單週單頁。</div>
   </label>
  </div>

  <button type="submit" id="convertBtn">開始轉換 → 下載分配表</button>

  <div id="progressContainer">
   <div class="note">正在處理並產生工作分配表中，請稍候…</div>
   <div class="progress-bar"><div id="progressFill" class="progress-bar-fill"></div></div>
  </div>
  <div id="doneMessage">檔案已成功生成並開始下載！</div>
 </form>
</div>

<script>
 const VALID_SHIFTS = ["*8-12/1-5", "8-12/1-5", "8'-12'/1'5'", "1-9", "1'-9'", "9-11'/13-15'", "9-11'", "8'-12'(休息日加班)", "8-12/1-5(國定假日加班)", "12/4值4-8", "值D8-8(民)", "值N8-8(民)", "值D8-8(民)(國定假日加班)", "值N8-8(民)(國定假日加班)", "值D8-8(民)(休息日加班)", "值N8-8(民)(休息日加班)"];
 const LONG_NAME_SHIFTS = [
  "值D8-8(民)(國定假日加班)", "值N8-8(民)(國定假日加班)", 
  "值D8-8(民)(休息日加班)", "值N8-8(民)(休息日加班)"
 ];
 const REST_SHIFTS = ['補休', '休息日', '例假日', '國定假日', '空班', '特別休假', '公休', '公假', '病假', '生理假', '事假', '家庭照顧假','喪假'];
 const LOCAL_STORAGE_KEY = 'clinic_list_data';

 function getChineseWeekday(date) { return ['日', '一', '二', '三', '四', '五', '六'][date.getDay()]; }
 function sortNamesByStroke(nameList) { return nameList.sort((a, b) => a.localeCompare(b, 'zh-TW')); }
 
 function cleanShiftName(shift) {
  if (!shift || ['nan', 'None', 'NaT', ''].includes(String(shift).trim())) return null;
  if (shift instanceof Date) return null;
  shift = String(shift).trim();
  if (VALID_SHIFTS.includes(shift)) return shift;
  return REST_SHIFTS.includes(shift) ? 'R' : shift;
 }

 function isDateLike(val) {
  const s = String(val).replace(/\n/g, '').trim();
  return (val instanceof Date && !isNaN(val)) || s.includes('202') || /\d{1,2}[\/-]\d{1,2}/.test(s);
 }

 function detectDefaultYear(rawData) {
  const s = JSON.stringify(rawData);
  const mAD = s.match(/202[4-6]/);
  return mAD ? parseInt(mAD[0]) : (s.match(/11[3-5]/) ? parseInt(s.match[0])+1911 : new Date().getFullYear());
 }
 
 function parseDateFlexible(val, defaultYear) {
  if (val instanceof Date) return val;
  let s = String(val).split('(')[0].replace(/\n/g, '').trim().replace(/\//g, '-');
  let d = new Date(s);
  if (!isNaN(d.getTime()) && s.includes('20')) return d;
  const match = s.match(/(\d{1,2})[-/](\d{1,2})/);
  return match ? new Date(defaultYear, parseInt(match[1]) - 1, parseInt(match[2])) : null;
 }

 async function updateClinicStatus(list) {
  const div = document.getElementById('clinicStatus');
  div.innerHTML = list?.length ? `<div class="success">✔ 已載入診次設定 (共 <strong>${list.length}</strong> 項)</div>` : '';
  document.getElementById('clinicFile').required = !list?.length;
 }

 async function loadClinicList(file) {
  return new Promise((resolve, reject) => {
   const reader = new FileReader();
   reader.onload = (e) => {
    try {
     const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
     const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
     const list = json.map(r => r[0]).filter(v => v && String(v).trim() !== '').map(s => String(s).trim());
     if (!list.length) throw new Error("診次檔案無效");
     localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(list));
     resolve(list);
    } catch (err) { reject(err); }
   };
   reader.readAsArrayBuffer(file);
  });
 }

 async function generateSchedule(scheduleFile, clinicList, mode) {
  return new Promise((resolve, reject) => {
   const reader = new FileReader();
   reader.onload = async (e) => {
    try {
     const data = new Uint8Array(e.target.result);
     const workbook = XLSX.read(data, { type: 'array', cellDates: true });
     const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1, raw: false });
     
     let hIdx = -1, nIdx = -1;
     for (let r = 0; r < 10; r++) {
      if (!rawData[r]) continue;
      rawData[r].forEach((c, i) => { if (String(c).replace(/\s/g,'').match(/姓名/)) { hIdx = r; nIdx = i; } });
      if (hIdx !== -1) break;
     }

     const defYear = detectDefaultYear(rawData);
     const dateCols = [];
     rawData[hIdx].forEach((col, i) => {
      if ((mode === 'auto' && i > nIdx) || (mode === 'fixed' && i >= 7 && i <= 13)) {
       if (isDateLike(col) && !String(col).match(/統計|備註|合計/)) {
        dateCols.push({ index: i, rawName: String(col).trim(), dateObj: col instanceof Date ? col : null });
       }
      }
     });

     const processedRows = [];
     const dataRows = (mode === 'auto') ? rawData.slice(hIdx + 1) : rawData.slice(3, 100);
     dataRows.forEach(row => {
      const name = row[nIdx];
      if (!name) return;
      dateCols.forEach(dCol => {
       const shift = cleanShiftName(row[dCol.index]);
       if (!shift) return;
       let dt = dCol.dateObj || parseDateFlexible(dCol.rawName, defYear);
       if (!dt) return;
       const startOfWeek = new Date(dt);
       startOfWeek.setDate(dt.getDate() - dt.getDay() + (dt.getDay() === 0 ? -6 : 1));
       startOfWeek.setHours(0,0,0,0);
       processedRows.push({ Date: dt, WeekKey: startOfWeek.getTime(), Name: String(name).trim(), Shift: shift });
      });
     });

     const wbOut = new ExcelJS.Workbook();
     const align = { horizontal: 'center', vertical: 'middle', wrapText: true };
     const border = { top:{style:'thin'}, left:{style:'thin'}, bottom:{style:'thin'}, right:{style:'thin'} };
     const contentFont = { name: '標楷體', size: 11 };

     const dataByWeek = processedRows.reduce((acc, r) => { (acc[r.WeekKey] = acc[r.WeekKey] || []).push(r); return acc; }, {});
     const weekKeys = Object.keys(dataByWeek).sort();

     for (const wk of weekKeys) {
      const weekStart = new Date(parseInt(wk));
      const ws = wbOut.addWorksheet(`${weekStart.getMonth()+1}${weekStart.getDate()}`);

      ws.pageSetup = { paperSize: 9, orientation: 'landscape', fitToPage: true, fitToWidth: 1, fitToHeight: 0, margins: {left:0.25, right:0.25, top:0.3, bottom:0.3, header:0.1, footer:0.1}, horizontalCentered: true };
      const footerTxt = `&L&"標楷體,12"列印日期: &D &T&C&"標楷體,12"請確認後簽名：芬____石____浩____榛____元____徐____慈____呂____昕____歡____陶____&R&"標楷體,12"護理長：______________________________`;
      ws.headerFooter = { oddFooter: footerTxt, evenFooter: footerTxt };

      ws.getColumn(1).width = 14;
      for (let i = 2; i <= 22; i += 3) { ws.getColumn(i).width = 10; ws.getColumn(i+1).width = 8; ws.getColumn(i+2).width = 8; }

      ws.getRow(1).height = 40; // 標題列
      ws.getRow(2).height = 30; // 日期列
      ws.getRow(3).height = 30; // 星期列
      ws.getRow(4).height = 30; // 標頭列

      ws.mergeCells('A1:V1');
      const cA1 = ws.getCell('A1'); cA1.value = "三軍總醫院_醫療部護理科門診_工作分配表"; cA1.alignment = align; cA1.font = { name:'標楷體', size:16, bold:true };
      ws.mergeCells('A2:A4');
      const cA2 = ws.getCell('A2'); cA2.value = "班別"; cA2.alignment = align; cA2.font = contentFont; cA2.border = border;

      const dateColMap = {};
      for (let i = 0; i < 7; i++) {
       const d = new Date(weekStart); d.setDate(weekStart.getDate() + i);
       const cIdx = 2 + (i * 3);
       const dStr = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`;
       ws.mergeCells(2, cIdx, 2, cIdx+2); ws.getCell(2, cIdx).value = dStr;
       ws.mergeCells(3, cIdx, 3, cIdx+2); ws.getCell(3, cIdx).value = getChineseWeekday(d);
       ws.getCell(4, cIdx).value = "姓名"; ws.getCell(4, cIdx+1).value = "上午診"; ws.getCell(4, cIdx+2).value = "下午診";
       [2,3,4].forEach(r => { for(let c=cIdx; c<=cIdx+2; c++) { const cell=ws.getCell(r,c); cell.font=contentFont; cell.alignment=align; cell.border=border; }});
       dateColMap[d.toDateString()] = cIdx;
      }

      let shifts = [...new Set(dataByWeek[wk].map(r => r.Shift))].sort((a,b) => {
       if (a === "*8-12/1-5") return -1; if (b === "*8-12/1-5") return 1;
       if (a === "R") return 1; if (b === "R") return -1;
       let iA = VALID_SHIFTS.indexOf(a), iB = VALID_SHIFTS.indexOf(b);
       return (iA===-1?500:iA) - (iB===-1?500:iB);
      });

      let curRow = 5;
      const dv = { type: 'list', formulae: [`"${clinicList.join(',')}"`], allowBlank: true };
      for (const shift of shifts) {
       const peopleByDay = {}; let maxR = 1;
       for (let i=0; i<7; i++) {
        const d = new Date(weekStart); d.setDate(weekStart.getDate()+i);
        const names = sortNamesByStroke(dataByWeek[wk].filter(r => r.Shift===shift && r.Date.toDateString()===d.toDateString()).map(r => r.Name));
        peopleByDay[d.toDateString()] = names; maxR = Math.max(maxR, names.length);
       }
       const startR = curRow;
       const rowFontSize = LONG_NAME_SHIFTS.includes(shift) ? 9 : 11;
       const rowFont = { name: '標楷體', size: rowFontSize };

       for (let i = 0; i < maxR; i++) {
        ws.getRow(curRow).height = (shift === 'R' ? 20 : 26);
        
        for (let j=0; j<7; j++) {
         const d = new Date(weekStart); d.setDate(weekStart.getDate()+j);
         const cIdx = dateColMap[d.toDateString()];
         const name = peopleByDay[d.toDateString()][i] || "";
         const c1 = ws.getCell(curRow, cIdx), c2 = ws.getCell(curRow, cIdx+1), c3 = ws.getCell(curRow, cIdx+2);
         c1.value = name; if(name) { c2.dataValidation = dv; c3.dataValidation = dv; }
         [c1,c2,c3].forEach(c => { c.font=rowFont; c.alignment=align; c.border=border; });
        }
        curRow++;
       }
       ws.mergeCells(startR, 1, curRow-1, 1);
       const sCell = ws.getCell(startR, 1); sCell.value = shift; 
       sCell.font = rowFont; sCell.alignment = align;
       for(let r=startR; r<curRow; r++) ws.getCell(r, 1).border = border;
      }
     }

     const buf = await wbOut.xlsx.writeBuffer();
     saveAs(new Blob([buf]), "三軍總醫院_醫療部護理科門診_工作分配表_完成檔.xlsx");
     resolve();
    } catch (err) { reject(err); }
   };
   reader.readAsArrayBuffer(scheduleFile);
  });
 }

 document.addEventListener('DOMContentLoaded', () => {
  const saved = localStorage.getItem(LOCAL_STORAGE_KEY);
  if (saved) updateClinicStatus(JSON.parse(saved));

  document.getElementById('clinicFile').addEventListener('change', async (e) => {
   try { const list = await loadClinicList(e.target.files[0]); updateClinicStatus(list); } catch(err) { alert(err.message); }
  });

  document.getElementById('uploadForm').addEventListener('submit', async (e) => {
   e.preventDefault();
   const file = document.getElementById('scheduleFile').files[0];
   const clinic = localStorage.getItem(LOCAL_STORAGE_KEY);
   if (!clinic || !file) return alert("請確認診次設定與班表檔案已上傳");
   
   document.getElementById("progressContainer").style.display = "block";
   try {
    await generateSchedule(file, JSON.parse(clinic), document.querySelector('input[name="extractionMode"]:checked').value);
    document.getElementById("progressFill").style.width = "100%";
    document.getElementById("doneMessage").style.display = "block";
   } catch (err) { alert("轉換失敗: " + err.message); }
  });
 });
</script>
</body>
</html>
